<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Review Assistant</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f7f7f8;
        height: 100vh;
        overflow: hidden;
      }

      .main-container {
        display: flex;
        height: 100vh;
        gap: 0;
      }

      .left-panel {
        width: 50%;
        background: white;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #d1d5db;
      }

      .header {
        padding: 24px 32px;
        border-bottom: 1px solid #e5e7eb;
        background: #ffffff;
      }

      h1 {
        color: #111827;
        margin-bottom: 6px;
        font-size: 28px;
        font-weight: 600;
      }

      .subtitle {
        color: #6b7280;
        font-size: 14px;
        font-weight: 400;
      }

      .input-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 24px 32px;
        overflow: hidden;
      }

      label {
        display: block;
        margin-bottom: 12px;
        color: #374151;
        font-weight: 600;
        font-size: 14px;
      }

      textarea {
        flex: 1;
        padding: 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 14px;
        resize: none;
        background: #ffffff;
        line-height: 1.6;
        color: #1f2937;
      }

      textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .button-group {
        padding: 20px 32px;
        display: flex;
        gap: 12px;
        border-top: 1px solid #e5e7eb;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
      }

      .btn-primary {
        background: #10a37f;
        color: white;
        flex: 1;
      }

      .btn-primary:hover:not(:disabled) {
        background: #0e906e;
      }

      .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        padding: 12px 24px;
        border: 1px solid #d1d5db;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .right-panel {
        width: 50%;
        background: #f7f7f8;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .results-header {
        padding: 24px 32px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
      }

      .results-header h2 {
        color: #111827;
        font-size: 20px;
        font-weight: 600;
      }

      .results-container {
        flex: 1;
        overflow-y: auto;
        padding: 24px 32px;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #9ca3af;
        text-align: center;
      }

      .empty-state p {
        font-size: 15px;
        color: #6b7280;
      }

      .result-section {
        background: white;
        border-radius: 12px;
        padding: 28px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }

      .result-section h3 {
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .result-section.security {
        border-left: 4px solid #ef4444;
      }

      .result-section.security h3 {
        color: #dc2626;
      }

      .result-section.performance {
        border-left: 4px solid #f59e0b;
      }

      .result-section.performance h3 {
        color: #d97706;
      }

      .result-section.readability {
        border-left: 4px solid #3b82f6;
      }

      .result-section.readability h3 {
        color: #2563eb;
      }

      .result-section.summary {
        border-left: 4px solid #10b981;
      }

      .result-section.summary h3 {
        color: #059669;
      }

      .result-content {
        color: #374151;
        font-size: 15px;
        line-height: 1.75;
      }

      .result-content h4 {
        font-size: 16px;
        font-weight: 700;
        color: #111827;
        margin-top: 20px;
        margin-bottom: 12px;
        letter-spacing: -0.01em;
      }

      .result-content h4:first-child {
        margin-top: 0;
      }

      .result-content p {
        margin-bottom: 16px;
        line-height: 1.75;
        color: #374151;
      }

      .result-content ul,
      .result-content ol {
        margin: 16px 0 16px 28px;
        line-height: 1.75;
      }

      .result-content li {
        margin-bottom: 10px;
        padding-left: 8px;
        color: #374151;
      }

      .result-content li::marker {
        color: #6b7280;
        font-weight: 600;
      }

      .result-content strong {
        font-weight: 700;
        color: #111827;
      }

      .result-content code {
        background: #f3f4f6;
        padding: 3px 8px;
        border-radius: 5px;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 13.5px;
        color: #dc2626;
        border: 1px solid #e5e7eb;
        font-weight: 500;
      }

      .result-content pre {
        background: #1f2937;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 16px 0;
        border: 1px solid #374151;
        position: relative;
      }

      .result-content pre code {
        background: none;
        padding: 0;
        color: #d1d5db;
        border: none;
        font-size: 13px;
        line-height: 1.6;
        display: block;
      }

      .severity-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 700;
        margin-left: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .severity-critical {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .severity-high {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .severity-medium {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }

      .severity-low {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .typing-indicator {
        display: inline-block;
        width: 4px;
        height: 18px;
        background: #10a37f;
        animation: blink 1s infinite;
        margin-left: 3px;
        vertical-align: middle;
        border-radius: 2px;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      .analyzing-badge {
        display: inline-block;
        background: #dbeafe;
        color: #1e40af;
        padding: 5px 14px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 12px;
        border: 1px solid #bfdbfe;
      }

      .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
      }

      .error-message strong {
        font-weight: 700;
      }

      .results-container::-webkit-scrollbar {
        width: 10px;
      }

      .results-container::-webkit-scrollbar-track {
        background: #f3f4f6;
      }

      .results-container::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 5px;
      }

      .results-container::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      @media (max-width: 1024px) {
        .main-container {
          flex-direction: column;
        }

        .left-panel,
        .right-panel {
          width: 100%;
          height: 50vh;
        }
      }

      @media (max-width: 768px) {
        .header,
        .input-container,
        .button-group,
        .results-header,
        .results-container {
          padding: 16px 20px;
        }

        h1 {
          font-size: 22px;
        }

        .button-group {
          flex-direction: column;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="left-panel">
        <div class="header">
          <h1>Code Review Assistant</h1>
          <p class="subtitle">Security-Performance-Readability</p>
        </div>

        <div class="input-container">
          <label for="codeInput">Enter Your Code:</label>
          <textarea
            id="codeInput"
            placeholder="Paste your code here for comprehensive analysis..."
            spellcheck="false"
          ></textarea>
        </div>

        <div class="button-group">
          <button type="button" class="btn-primary" id="analyzeBtn">
            Analyze Code
          </button>
          <button type="button" class="btn-secondary" id="clearBtn">
            Clear
          </button>
        </div>
      </div>

      <div class="right-panel">
        <div class="results-header">
          <h2>Analysis Results</h2>
        </div>

        <div class="results-container" id="resultsContainer">
          <div class="empty-state" id="emptyState">
            <p>Enter code and click "Analyze Code" to see results here</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const codeInput = document.getElementById("codeInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const clearBtn = document.getElementById("clearBtn");
      const resultsContainer = document.getElementById("resultsContainer");
      const emptyState = document.getElementById("emptyState");

      let sectionContents = {
        security: "",
        performance: "",
        readability: "",
        summary: "",
      };

      const sectionTitles = {
        security: "Security Analysis",
        performance: "Performance Analysis",
        readability: "Readability Analysis",
        summary: "Comprehensive Summary",
      };

      analyzeBtn.addEventListener("click", startAnalysis);
      clearBtn.addEventListener("click", clearAll);

      function startAnalysis() {
        const code = codeInput.value.trim();
        if (!code) {
          alert("Please enter code to analyze");
          return;
        }

        sectionContents = {
          security: "",
          performance: "",
          readability: "",
          summary: "",
        };

        emptyState.style.display = "none";
        resultsContainer.innerHTML = "";
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "Analyzing...";

        const formData = new FormData();
        formData.append("code", code);

        fetch("/review", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function readStream() {
              reader.read().then(({ done, value }) => {
                if (done) {
                  analyzeBtn.disabled = false;
                  analyzeBtn.textContent = "Analyze Code";
                  return;
                }

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split("\n");

                lines.forEach((line) => {
                  if (line.startsWith("data: ")) {
                    try {
                      const data = JSON.parse(line.substring(6));
                      handleStreamEvent(data);
                    } catch (e) {
                      console.error("Parse error:", e);
                    }
                  }
                });

                readStream();
              });
            }

            readStream();
          })
          .catch((error) => {
            console.error("Error:", error);
            showError("Failed to connect to server. Please try again.");
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = "Analyze Code";
          });
      }

      function handleStreamEvent(data) {
        switch (data.type) {
          case "section_start":
            createSection(data.section);
            break;

          case "content":
            appendContent(data.section, data.content);
            break;

          case "section_complete":
            completeSection(data.section);
            break;

          case "complete":
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = "Analyze Code";
            break;

          case "error":
            showError(data.message);
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = "Analyze Code";
            break;
        }
      }

      function createSection(section) {
        const sectionDiv = document.createElement("div");
        sectionDiv.className = `result-section ${section}`;
        sectionDiv.id = `section-${section}`;

        const header = document.createElement("h3");
        header.innerHTML = `${sectionTitles[section]} <span class="analyzing-badge">Analyzing...</span>`;

        const content = document.createElement("div");
        content.className = "result-content";
        content.id = `content-${section}`;

        sectionDiv.appendChild(header);
        sectionDiv.appendChild(content);
        resultsContainer.appendChild(sectionDiv);

        sectionDiv.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function appendContent(section, text) {
        const contentDiv = document.getElementById(`content-${section}`);
        if (contentDiv) {
          sectionContents[section] += text;

          let formattedHTML = formatText(sectionContents[section]);
          contentDiv.innerHTML = formattedHTML;

          const indicator = document.createElement("span");
          indicator.className = "typing-indicator";
          contentDiv.appendChild(indicator);

          contentDiv.scrollIntoView({ behavior: "smooth", block: "end" });
        }
      }

      function completeSection(section) {
        const sectionDiv = document.getElementById(`section-${section}`);
        if (sectionDiv) {
          const badge = sectionDiv.querySelector(".analyzing-badge");
          if (badge) {
            badge.remove();
          }

          const contentDiv = document.getElementById(`content-${section}`);
          if (contentDiv) {
            const indicator = contentDiv.querySelector(".typing-indicator");
            if (indicator) {
              indicator.remove();
            }

            let formattedHTML = formatText(sectionContents[section]);
            contentDiv.innerHTML = formattedHTML;
          }
        }
      }

      function formatText(text) {
        let html = text;

        // Remove escaped newlines
        html = html.replace(/\\n/g, "\n");

        // Convert headers
        html = html.replace(/^###\s+(.+)$/gm, "<h4>$1</h4>");
        html = html.replace(/^##\s+(.+)$/gm, "<h4>$1</h4>");
        html = html.replace(/^\*\*([^:]+):\*\*/gm, "<h4>$1:</h4>");

        // Convert bold text
        html = html.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        html = html.replace(/__([^_]+)__/g, "<strong>$1</strong>");

        // Convert severity badges
        html = html.replace(
          /Severity:\s*(Critical|High|Medium|Low)/gi,
          (match, severity) =>
            `<strong>Severity:</strong><span class="severity-badge severity-${severity.toLowerCase()}">${severity}</span>`
        );

        // Convert inline code
        html = html.replace(/`([^`]+)`/g, "<code>$1</code>");

        // Convert code blocks
        html = html.replace(
          /```(\w+)?\n([\s\S]+?)```/g,
          "<pre><code>$2</code></pre>"
        );

        // Convert numbered lists
        html = html.replace(/^\d+\.\s+(.+)$/gm, "<li>$1</li>");
        html = html.replace(/(<li>.*<\/li>\n?)+/g, "<ol>$&</ol>");

        // Convert bullet lists
        html = html.replace(/^[-*]\s+(.+)$/gm, "<li>$1</li>");
        html = html.replace(
          /(?<!<ol>)(<li>.*<\/li>\n?)+(?!<\/ol>)/g,
          "<ul>$&</ul>"
        );

        // Convert paragraphs
        html = html
          .split("\n\n")
          .map((para) => {
            para = para.trim();
            if (
              para &&
              !para.startsWith("<") &&
              !para.match(/^<(h4|ul|ol|pre)/)
            ) {
              return "<p>" + para.replace(/\n/g, " ") + "</p>";
            }
            return para;
          })
          .join("\n");

        return html;
      }

      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
        resultsContainer.insertBefore(errorDiv, resultsContainer.firstChild);
      }

      function clearAll() {
        codeInput.value = "";
        resultsContainer.innerHTML = "";
        emptyState.style.display = "flex";
        sectionContents = {
          security: "",
          performance: "",
          readability: "",
          summary: "",
        };

        analyzeBtn.disabled = false;
        analyzeBtn.textContent = "Analyze Code";
      }
    </script>
  </body>
</html>
